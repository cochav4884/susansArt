<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Art Tracker</title>

  <link rel="icon" type="image/png" href="public/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="public/favicon.svg" />
  <link rel="shortcut icon" href="public/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="public/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="susansArt" />
  <link rel="manifest" href="public/site.webmanifest" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles/index.css">
</head>

<body>

<header class="nav">
  <a href="index.html" class="back-btn">
    <img src="public/favicon.ico" alt="Art Tracker Logo" class="nav-avatar">
  </a>
  <span class="nav-brand">Art Tracker</span>
</header>

<section class="jumbotron">
  <div>
    <img src="images/susan.jpg" alt="Picture of Artist Susan" class="jumbotron-avatar">
    <h1>Artist: <span class="artist-name">Susan</span></h1>
    <p>Track every art project from concept to completion.</p>
  </div>
</section>

<main>
  <section id="cardsContainer"></section>

  <div class="controls">
    <button type="button" id="addCard">â• Add Project</button>
    <button type="button" id="resetAll">ğŸ”„ Reset All</button>
  </div>
</main>

<footer class="site-footer">
  <p>Artist: Susan | <span id="year"></span></p>
  <p>
    <a href="privacyPolicy.html">Privacy Policy</a> |
    <a href="legalDisclaimer.html">Legal Disclaimer</a>
  </p>
</footer>

<script>
const STORAGE_KEY = "artCards";
const STAGES = ["Concept", "Sketch", "In Progress", "Original", "Completed"];
const MEDIUMS = ["Pencil","Paint","Digital","Charcoal","Pen","Sharpie","Marker","Gel Pen","White Out"];

// Create empty card object
function createEmptyCard() {
  return {
    title: "",
    stages: Array(5).fill(false),
    images: Array(5).fill(null).map(() => []),
    startDate: "",
    completionDate: "",
    medium: [],   // array now for multiple selections
    notes: ""
  };
}

// Load from localStorage
function loadCards() {
  const data = localStorage.getItem(STORAGE_KEY);
  return data ? JSON.parse(data) : [createEmptyCard()];
}

// Save to localStorage
function saveCards(cards) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(cards));
}

// Resize images
function resizeImage(file, callback) {
  const img = new Image();
  const reader = new FileReader();

  reader.onload = e => img.src = e.target.result;

  img.onload = () => {
    const canvas = document.createElement("canvas");
    const max = 800;
    let { width, height } = img;

    if (width > height && width > max) {
      height *= max / width;
      width = max;
    } else if (height > max) {
      width *= max / height;
      height = max;
    }

    canvas.width = width;
    canvas.height = height;
    canvas.getContext("2d").drawImage(img, 0, 0, width, height);
    callback(canvas.toDataURL("image/jpeg", 0.8));
  };

  reader.readAsDataURL(file);
}

// Render all cards
function renderCards() {
  const container = document.getElementById("cardsContainer");
  container.innerHTML = "";
  const cards = loadCards();

  cards.forEach((card, index) => {
    const cardEl = document.createElement("div");
    cardEl.className = "art-card collapsed"; // start collapsed

    const isCompleted = card.stages[4] === true;

    // Medium checkboxes
    const mediumHTML = MEDIUMS.map(m => `
      <label>
        <input type="checkbox" value="${m}" ${card.medium.includes(m) ? "checked" : ""}>
        ${m}
      </label>
    `).join("");

    cardEl.innerHTML = `
      <div class="title-container">
        <input class="title" placeholder="Project Title" value="${card.title}">
        <button class="btn delete">ğŸ—‘ï¸</button>
      </div>

      <div class="card-content">
        <div class="stages">
          ${STAGES.map((s,i)=>`
            <div class="stage-block">
              <label>
                <input type="checkbox" ${card.stages[i] ? "checked" : ""}>
                ${s}
              </label>
              <input type="file" accept="image/*" data-stage="${i}" multiple>
              <div class="image-preview">
                ${(card.images[i] || []).map((img, imgIndex) => `
                  <div class="preview-container">
                    <img src="${img}" alt="Stage ${s} Image">
                    <button class="remove-image" data-stage="${i}" data-index="${imgIndex}">âŒ</button>
                  </div>
                `).join("")}
              </div>
            </div>
          `).join("")}
        </div>

        <fieldset class="medium">
          <legend>Medium</legend>
          ${mediumHTML}
        </fieldset>

        <div class="extras">
          <label>Start Date <input type="date" value="${card.startDate}"></label>
          <label>Completion Date <input type="date" value="${card.completionDate}"></label>
        </div>

        <textarea placeholder="Notes, ideas, reflections...">${card.notes}</textarea>

        <div class="card-actions">
          <button class="btn view-art" style="display:${isCompleted ? "inline-block" : "none"}">ğŸ¨ View Art</button>
          <button class="btn reset">ğŸ”„ Reset This Project</button>
        </div>
      </div>
    `;

    // Toggle collapse
    cardEl.querySelector(".title-container").onclick = e => {
      if (e.target.classList.contains("delete")) return;
      cardEl.classList.toggle("collapsed");
    };

    // Title
    cardEl.querySelector(".title").onblur = e => {
      cards[index].title = e.target.value;
      saveCards(cards);
    };

    // Delete
    cardEl.querySelector(".delete").onclick = () => {
      if (confirm("Delete this project?")) {
        cards.splice(index,1);
        saveCards(cards);
        renderCards();
      }
    };

    // Stage checkboxes
    cardEl.querySelectorAll(".stages input[type=checkbox]").forEach((box,i)=>{
      box.onchange = e => {
        cards[index].stages[i] = e.target.checked;
        if (STAGES[i] === "Completed" && e.target.checked) {
          cards[index].completionDate = new Date().toISOString().split("T")[0];
        }
        saveCards(cards);
        renderCards();
      };
    });

    // Image upload
    cardEl.querySelectorAll("input[type=file]").forEach(input=>{
      input.onchange = e => {
        const files = Array.from(e.target.files);
        const stage = e.target.dataset.stage;
        files.forEach(file => {
          resizeImage(file, img=>{
            cards[index].images[stage].push(img);
            saveCards(cards);
            renderCards();
          });
        });
        e.target.value = "";
      };
    });

    // Remove image
    cardEl.addEventListener("click", e => {
      if (e.target.classList.contains("remove-image")) {
        const stage = e.target.dataset.stage;
        const imgIndex = e.target.dataset.index;
        cards[index].images[stage].splice(imgIndex,1);
        saveCards(cards);
        renderCards();
      }
    });

    // Medium checkboxes
    cardEl.querySelectorAll("fieldset.medium input[type=checkbox]").forEach(cb => {
      cb.onchange = e => {
        if (e.target.checked) {
          if (!cards[index].medium.includes(e.target.value)) cards[index].medium.push(e.target.value);
        } else {
          cards[index].medium = cards[index].medium.filter(m => m !== e.target.value);
        }
        saveCards(cards);
      };
    });

    // Dates
    const dateInputs = cardEl.querySelectorAll("input[type=date]");
    dateInputs[0].onchange = e => { cards[index].startDate = e.target.value; saveCards(cards); };
    dateInputs[1].onchange = e => { cards[index].completionDate = e.target.value; saveCards(cards); };

    // Notes
    cardEl.querySelector("textarea").onblur = e => { cards[index].notes = e.target.value; saveCards(cards); };

    // View Art
    cardEl.querySelector(".view-art").onclick = () => { window.location.href = "art.html"; };

    // Reset project
    cardEl.querySelector(".reset").onclick = () => {
      cards[index] = createEmptyCard();
      saveCards(cards);
      renderCards();
    };

    container.appendChild(cardEl);
  });
}

// Add new card
document.getElementById("addCard").onclick = () => {
  const cards = loadCards();
  cards.push(createEmptyCard());
  saveCards(cards);
  renderCards();
};

// Reset all
document.getElementById("resetAll").onclick = () => {
  if (confirm("Reset all projects?")) {
    localStorage.removeItem(STORAGE_KEY);
    renderCards();
  }
};

document.getElementById("year").textContent = new Date().getFullYear();
renderCards();
</script>

</body>
</html>
